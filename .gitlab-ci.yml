variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  SONAR_HOST_URL: https://sonarcloud.io

image: $CI_REGISTRY/autowp/runner-base-image

stages:
  - test
  - build
  - publish

test:
  stage: test
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  script:
    - npm install
    - ./node_modules/.bin/ng lint
    - sonar-scanner -Dsonar.login=$SONAR_TOKEN
  interruptible: true
  rules:
    - if: $CI_COMMIT_TAG !~ /^v\d.*/

build:
  stage: build
  script:
    - npm install
    - ./node_modules/.bin/ng build --configuration production --no-progress --base-href=/ --extra-webpack-config webpack.extra.js
    - npx semantic-release
  rules:
    - if: $CI_COMMIT_TAG !~ /^v\d.*/

build-release:
  stage: build
  services:
    - name: docker:dind
      alias: docker
  before_script:
    - waitforit -address=tcp://docker:2375 -timeout=30
  script:
    - npm install
    - "jq -n --arg release \"$CI_COMMIT_TAG\" '{release: $release}' > src/version.json"
    - ./node_modules/.bin/ng build --configuration production --no-progress --base-href=/ --extra-webpack-config webpack.extra.js

    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY_IMAGE"
    - docker pull "$CI_REGISTRY_IMAGE" || true
    - docker build . -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"
    - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d.*/

publish:
  stage: publish
  services:
    - name: docker:dind
      alias: docker
  before_script:
    - waitforit -address=tcp://docker:2375 -timeout=30
  script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY_IMAGE"
    - docker pull "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"
    - docker tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG" autowp/autowp-frontend:$CI_COMMIT_TAG
    - docker push autowp/autowp-frontend:$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d.*/
